#!/bin/bash

# Log Archive Tool
# Description: Compresses logs and stores them with timestamp
# Usage: ./log-archive <log-directory>

# Check if directory argument is provided
if [ $# -eq 0 ]; then
    echo "Error: No log directory provided"
    echo "Usage: ./log-archive <log-directory>"
    exit 1
fi

LOG_DIR="$1"

# Check if the directory exists
if [ ! -d "$LOG_DIR" ]; then
    echo "Error: Directory '$LOG_DIR' does not exist"
    exit 1
fi

# Check if directory has any files
if [ -z "$(ls -A $LOG_DIR)" ]; then
    echo "Error: Directory '$LOG_DIR' is empty"
    exit 1
fi

# Create archive directory if it doesn't exist
ARCHIVE_DIR="./archives"
mkdir -p "$ARCHIVE_DIR"

# Generate timestamp (format: YYYYMMDD_HHMMSS)
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")

# Create archive filename
ARCHIVE_NAME="logs_archive_${TIMESTAMP}.tar.gz"
ARCHIVE_PATH="$ARCHIVE_DIR/$ARCHIVE_NAME"

# Create the compressed archive
echo "Archiving logs from: $LOG_DIR"
echo "Creating archive: $ARCHIVE_NAME"

tar -czf "$ARCHIVE_PATH" -C "$(dirname $LOG_DIR)" "$(basename $LOG_DIR)" 2>/dev/null

# Check if archive was created successfully
if [ $? -eq 0 ]; then
    ARCHIVE_SIZE=$(du -h "$ARCHIVE_PATH" | cut -f1)
    echo "✓ Archive created successfully!"
    echo "  Location: $ARCHIVE_PATH"
    echo "  Size: $ARCHIVE_SIZE"
    
    # Log the archive creation to a log file
    LOG_FILE="$ARCHIVE_DIR/archive_log.txt"
    echo "[$TIMESTAMP] Archived $LOG_DIR -> $ARCHIVE_NAME ($ARCHIVE_SIZE)" >> "$LOG_FILE"
    echo "✓ Archive logged to: $LOG_FILE"
else
    echo "✗ Error: Failed to create archive"
    exit 1
fi
